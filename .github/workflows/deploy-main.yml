name: 游 Deploy to PRODUCTION

on:
  push:
    branches: [main]

env:
  REPO_NAME: "acuarela-nueva-vps"
  PROD_PATH: "/home/webadmin/acuarela"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout c칩digo (solo 칰ltimo commit = m치s r치pido)
      - name: 游닌 Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 2. Configurar SSH
      - name: 游댏 Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      # 3. Sincronizar c칩digo con rsync (solo cambios)
      # cache/ y miembros/cache/ est치n en .gitignore; rsync --delete los borrar칤a en cada deploy.
      # --filter 'p ...' protege esas carpetas en destino para no borrar el cache del servidor.
      - name: 游댃 Sync code to VPS
        run: |
          rsync -avz --delete \
            --omit-dir-times \
            --no-perms \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            --exclude='.git/' \
            --exclude='.github/' \
            --exclude='.env' \
            --exclude='.well-known/' \
            --exclude='vendor/' \
            --exclude='cache/' \
            --exclude='logs/' \
            --exclude='error_log' \
            --exclude='*.log' \
            --exclude='certs/' \
            --exclude='.vscode/' \
            --exclude='.idea/' \
            --exclude='*.swp' \
            --exclude='*.swo' \
            --exclude='DEPLOY_VERSION.txt' \
            --exclude='miembros/acuarela-app-web/marketplace/stripe/' \
            --exclude='miembros/acuarela-app-web/marketplaceapp/stripe/' \
            --filter 'p cache/' \
            --filter 'p miembros/cache/' \
            ./ ${{ secrets.SSH_USERNAME }}@${{ secrets.VPS_HOST }}:${{ env.PROD_PATH }}/

      # 4. Ejecutar script de deploy en el servidor
      - name: 游 Execute deploy script
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          envs: GITHUB_SHA
          script: |
            cd ${{ env.PROD_PATH }}
            # Convertir formato de l칤nea a LF (Linux) si es necesario
            sed -i 's/\r$//' deploy-production.sh
            chmod +x deploy-production.sh
            export GITHUB_SHA="${{ github.sha }}"
            ./deploy-production.sh

      # 5. Limpiar llave SSH
      - name: 游빛 Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key
