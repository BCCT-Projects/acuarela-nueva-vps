# Configuración de Apache - PRODUCCIÓN con SSL/TLS Seguro
# Revisión: v2.0 - Implementación cautelosa basada en post-mortem del 23/01/2026

# ============================================
# MÓDULO: Restaurar IP real desde Cloudflare
# ============================================
<IfModule mod_remoteip.c>
    RemoteIPHeader CF-Connecting-IP
</IfModule>

# ============================================
# VHOST: Puerto 80 - Redirección a HTTPS
# ============================================
<VirtualHost *:80>
    ServerAdmin webmaster@acuarela.app
    ServerName acuarela.app
    ServerAlias www.acuarela.app
    
    # Redirección permanente a HTTPS
    Redirect permanent / https://acuarela.app/
</VirtualHost>

# ============================================
# VHOST: Puerto 443 - HTTPS Principal
# ============================================
<VirtualHost *:443>
    ServerAdmin webmaster@acuarela.app
    ServerName acuarela.app
    ServerAlias www.acuarela.app

    DocumentRoot /var/www/html

    # ========== SSL Configuration ==========
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/acuarela.crt
    SSLCertificateKeyFile /etc/ssl/certs/acuarela.key
    
    # TLS Moderno (1.2 mínimo, 1.3 preferido)
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite HIGH:!aNULL:!MD5:!RC4:!3DES
    SSLHonorCipherOrder on

    # ========== Directory Principal ==========
    <Directory /var/www/html>
        Options -Indexes +FollowSymLinks -MultiViews
        AllowOverride All
        Require all granted
        DirectoryIndex index.php index.html
    </Directory>

    # ========== Bloqueo de Archivos Sensibles ==========
    # Archivos que empiezan con punto (ej: .env, .git, .htaccess)
    <FilesMatch "^\.">
        Require all denied
    </FilesMatch>
    
    # Extensiones peligrosas
    <FilesMatch "\.(env|ini|log|sql|bak|swp|old|orig)$">
        Require all denied
    </FilesMatch>

    # ========== Bloqueo de Directorios Sensibles ==========
    # NOTA: NO bloquear /uploads ni /includes (lección aprendida)
    <LocationMatch "^/(\.git|\.svn|config|logs|backups)">
        Require all denied
    </LocationMatch>

    # ========== Configuración de Assets (Cache/CORS) ==========
    <FilesMatch "\.css$">
        Header set Content-Type "text/css; charset=UTF-8"
        Header set Cache-Control "public, max-age=604800, immutable"
        Header set X-Content-Type-Options "nosniff"
        Header always set Access-Control-Allow-Origin "*"
    </FilesMatch>

    <FilesMatch "\.js$">
        Header set Content-Type "application/javascript; charset=UTF-8"
        Header set Cache-Control "public, max-age=604800, immutable"
        Header set X-Content-Type-Options "nosniff"
    </FilesMatch>

    <FilesMatch "\.(ttf|otf|eot|woff|woff2)$">
        Header set Access-Control-Allow-Origin "*"
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>

    <FilesMatch "\.(jpg|jpeg|png|gif|svg|ico|webp|mp4|webm)$">
        Header set Cache-Control "public, max-age=2592000, immutable"
        Header set Access-Control-Allow-Origin "*"
    </FilesMatch>

    # ========== Compresión GZIP ==========
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript
        AddOutputFilterByType DEFLATE application/javascript application/json application/xml
        AddOutputFilterByType DEFLATE application/rss+xml application/atom+xml
        AddOutputFilterByType DEFLATE image/svg+xml
    </IfModule>

    # ========== CABECERAS DE SEGURIDAD ==========
    <IfModule mod_headers.c>
        # --- HSTS (Forzar HTTPS por 1 año) ---
        Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
        
        # --- Prevenir Clickjacking ---
        Header always set X-Frame-Options "DENY"
        
        # --- Prevenir MIME Sniffing ---
        Header always set X-Content-Type-Options "nosniff"
        
        # --- XSS Protection (Legacy browsers) ---
        Header always set X-XSS-Protection "1; mode=block"
        
        # --- Referrer Policy ---
        Header always set Referrer-Policy "strict-origin-when-cross-origin"
        
        # --- Permissions Policy (APIs deshabilitadas) ---
        Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
        
        # --- CSP en MODO REPORT-ONLY (NO BLOQUEA, SOLO REPORTA) ---
        # Esto permite detectar qué se rompería sin afectar la funcionalidad.
        # Una vez validado, cambiar a "Content-Security-Policy" para activarlo.
        Header always set Content-Security-Policy-Report-Only "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https: data:; img-src * data: blob:; media-src * data: blob:; connect-src *; frame-src *; frame-ancestors 'none'; object-src 'none'; base-uri 'self';"
    </IfModule>

    # ========== Ocultar Información del Servidor ==========
    ServerSignature Off

    # ========== Logs ==========
    ErrorLog ${APACHE_LOG_DIR}/acuarela_ssl_error.log
    CustomLog ${APACHE_LOG_DIR}/acuarela_ssl_access.log combined
    LogLevel warn

</VirtualHost>
