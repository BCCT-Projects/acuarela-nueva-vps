name: üöÄ Deploy to DEV (acuarela-app-web)

on:
  push:
    branches: [dev]

env:
  REPO_NAME: "acuarela-app-web"
  DEV_PATH: "/home/oldmacdonald/public_html/dev2/miembros/acuarela-app-web"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout con historial para detectar cambios en composer
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # 2. Detectar si composer.json existe (se verificar√° vendor/ en servidor)
      - name: üîç Check if composer.json exists
        id: composer-check
        run: |
          if [ -f "composer.json" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "üì¶ composer.json encontrado - verificar√° vendor/ en servidor"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è No hay composer.json - skipping"
          fi

      # 3. Instalar sshpass para usar password con rsync
      - name: üîß Install sshpass
        run: sudo apt-get install -y sshpass

      # 4. Agregar host a known_hosts
      - name: üîê Setup known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      # 5. Sync archivos con rsync
      # NOTA: Exclusiones basadas en DRIFT_acuarela-app-web_2024-12-22.md
      # .env contiene credenciales y se sube manualmente al servidor
      - name: üîÑ Rsync source files
        run: |
          sshpass -p "${{ secrets.SSH_PASSWORD }}" rsync -avz --delete \
            --omit-dir-times \
            --no-perms \
            --exclude='.git/' \
            --exclude='.github/' \
            --exclude='.env' \
            --exclude='.well-known/' \
            --exclude='vendor/' \
            --exclude='cache/' \
            --exclude='marketplace/stripe/' \
            --exclude='marketplaceapp/stripe/' \
            --exclude='videos/' \
            --exclude='error_log' \
            --exclude='*.log' \
            --exclude='DEPLOY_VERSION.txt' \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ ${{ secrets.SSH_USERNAME }}@${{ secrets.VPS_HOST }}:${{ env.DEV_PATH }}/

      # 6. Composer install EN EL SERVIDOR (si falta vendor/ o composer.lock)
      - name: üì¶ Composer install on server
        if: steps.composer-check.outputs.exists == 'true'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          script: |
            cd ${{ env.DEV_PATH }}
            
            # Solo ejecutar si falta vendor/ o composer.lock
            if [ ! -d "vendor" ] || [ ! -f "composer.lock" ]; then
              echo "üì¶ vendor/ o composer.lock no existe - instalando dependencias..."
              composer install --no-dev --optimize-autoloader --no-interaction
              echo "‚úÖ Dependencies installed"
            else
              echo "‚úÖ vendor/ ya existe - verificando actualizaci√≥n..."
              composer install --no-dev --optimize-autoloader --no-interaction
              echo "‚úÖ Dependencies verified/updated"
            fi

      # 6.1. Verificar que composer install funcion√≥ correctamente
      - name: ‚úÖ Verify composer install
        if: steps.composer-check.outputs.exists == 'true'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          script: |
            cd ${{ env.DEV_PATH }}
            echo "üîç Verificando instalaci√≥n de Composer..."
            
            # Verificar que vendor existe
            if [ ! -d "vendor" ]; then
              echo "‚ùå ERROR: Directorio vendor/ no existe"
              exit 1
            fi
            echo "‚úÖ Directorio vendor/ existe"
            
            # Verificar que el autoloader existe
            if [ ! -f "vendor/autoload.php" ]; then
              echo "‚ùå ERROR: vendor/autoload.php no existe"
              exit 1
            fi
            echo "‚úÖ Autoloader (vendor/autoload.php) existe"
            
            # Verificar que stripe est√° instalado
            if [ ! -d "vendor/stripe" ]; then
              echo "‚ùå ERROR: stripe/stripe-php no est√° instalado"
              exit 1
            fi
            echo "‚úÖ stripe/stripe-php est√° instalado"
            
            # Verificar con composer show
            echo "üì¶ Dependencias instaladas:"
            composer show --installed || echo "‚ö†Ô∏è composer show fall√≥, pero las dependencias parecen estar instaladas"
            
            # Test real: cargar autoloader con PHP
            echo "üß™ Probando autoloader con PHP..."
            php -r "require 'vendor/autoload.php'; echo class_exists('Stripe\Stripe') ? '‚úÖ Stripe\Stripe carga correctamente' : '‚ùå ERROR: Stripe no se puede cargar'; echo PHP_EOL;"
            
            if [ $? -ne 0 ]; then
              echo "‚ùå ERROR: El autoloader de PHP fall√≥"
              exit 1
            fi
            
            echo "‚úÖ Verificaci√≥n completada - Composer install funcion√≥ correctamente"

      # 7. Corregir permisos (archivos desplegados quedan como peekaroot)
      - name: üîê Fix file ownership
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          script: |
            echo "üîê Corrigiendo permisos de archivos desplegados..."
            cd ${{ env.DEV_PATH }}
            # Cambiar owner de archivos que quedaron como peekaroot
            find . -user peekaroot -exec chown oldmacdonald:oldmacdonald {} \; 2>/dev/null || true
            echo "‚úÖ Permisos corregidos"

      # 8. Crear DEPLOY_VERSION.txt en el servidor
      - name: üìù Create DEPLOY_VERSION.txt
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          script: |
            cat > ${{ env.DEV_PATH }}/DEPLOY_VERSION.txt << EOF
            =====================================
            DEPLOY INFO
            =====================================
            Repository: ${{ env.REPO_NAME }}
            Environment: DEV
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            Date: $(TZ='America/New_York' date '+%Y-%m-%d %H:%M:%S')
            Composer: ${{ steps.composer-check.outputs.exists == 'true' && 'verified' || 'skipped' }}
            =====================================
            EOF

  # Crear PR autom√°tico a main (usando GitHub CLI)
  create-pr:
    needs: deploy
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üìã Create or Update Pull Request
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          COMMIT_SHA: ${{ github.sha }}
          COMMIT_AUTHOR: ${{ github.actor }}
        run: |
          PR_BODY="## Cambios listos para producci√≥n

          **Repositorio:** acuarela-app-web
          **Commit:** ${COMMIT_SHA}
          **Autor:** @${COMMIT_AUTHOR}

          ### Checklist:
          - [ ] Probado en DEV
          - [ ] Sin errores en consola
          - [ ] Funcionalidad verificada"
          
          # Verificar si ya existe un PR abierto
          EXISTING_PR=$(gh pr list --base main --head dev --state open --json number -q '.[0].number' 2>/dev/null || echo "")
          
          if [ -n "$EXISTING_PR" ]; then
            echo "‚úÖ PR #${EXISTING_PR} ya existe - los nuevos commits se agregaron autom√°ticamente"
            # Intentar asignar reviewer si no tiene
            gh pr edit "$EXISTING_PR" --add-reviewer tecnologia-afma 2>/dev/null || true
            gh pr edit "$EXISTING_PR" --add-assignee tecnologia-afma 2>/dev/null || true
          else
            echo "üìã Creando nuevo PR..."
            # Crear PR sin reviewer (evita error de permisos)
            gh pr create --base main --head dev --title "üöÄ Deploy: ${COMMIT_MSG}" --body "$PR_BODY" || echo "‚ö†Ô∏è No se pudo crear PR autom√°ticamente."
            
            # Asignar reviewer y assignee por separado
            sleep 2
            NEW_PR=$(gh pr list --base main --head dev --state open --json number -q '.[0].number' 2>/dev/null || echo "")
            if [ -n "$NEW_PR" ]; then
              echo "üìå Asignando reviewer a PR #${NEW_PR}..."
              gh pr edit "$NEW_PR" --add-reviewer tecnologia-afma 2>/dev/null || echo "‚ö†Ô∏è No se pudo asignar reviewer"
              gh pr edit "$NEW_PR" --add-assignee tecnologia-afma 2>/dev/null || echo "‚ö†Ô∏è No se pudo asignar assignee"
            fi
          fi

